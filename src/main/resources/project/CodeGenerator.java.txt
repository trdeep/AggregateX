package cn.treedeep.king;

import cn.treedeep.king.generator.config.DDDJsonConfigTool;
import cn.treedeep.king.shared.utils.ResourceUtil;
import lombok.extern.slf4j.Slf4j;

import java.io.IOException;
import java.nio.file.Files;
import java.nio.file.Path;
import java.nio.file.Paths;
import java.time.LocalDateTime;
import java.time.format.DateTimeFormatter;

/**
 * AggregateX DDD é¡¹ç›®ä»£ç ç”Ÿæˆå™¨
 */
@Slf4j
public class CodeGenerator {

    final static String PACKAGE_NAME = "cn.treedeep.king.admin";
    final static String PROJECT_PATH = "/Users/zhougm/vscode/KingAdmin";
    final static String BACKUP_DIR = PROJECT_PATH + "/src/main/resources/module_backups";

    public static void main(String[] args) {
        generateByJson();
    }

    private static void generateByJson() {
        DDDJsonConfigTool tool = new DDDJsonConfigTool();
        String jsonContent = ResourceUtil.readResource("module-info.json5");

        try {
            // 1. æ‰§è¡Œä»£ç ç”Ÿæˆ
            tool.generateFromJsonString(jsonContent, PROJECT_PATH, PACKAGE_NAME);

            // 2. å¤‡ä»½é…ç½®æ–‡ä»¶
            backupJsonContent(jsonContent);

            log.info("âœ… æ¨¡å—ä»£ç å·²ç”Ÿæˆï¼Œé…ç½®æ–‡ä»¶å·²å¤‡ä»½");
        } catch (Exception e) {
            log.error("âŒ ä»£ç ç”Ÿæˆå¤±è´¥", e);
        }
    }

    private static void backupJsonContent(String jsonContent) throws IOException {
        // åˆ›å»ºå¤‡ä»½ç›®å½•ï¼ˆå¦‚æœä¸å­˜åœ¨ï¼‰
        Path backupPath = Paths.get(BACKUP_DIR);
        if (!Files.exists(backupPath)) {
            Files.createDirectories(backupPath);
        }

        // ç”Ÿæˆå¸¦æ—¶é—´æˆ³çš„å¤‡ä»½æ–‡ä»¶å
        String timestamp = LocalDateTime.now().format(DateTimeFormatter.ofPattern("yyyyMMdd_HHmmss"));
        String backupFileName = "module-info_" + timestamp + ".json5";

        // æ„å»ºç›®æ ‡è·¯å¾„
        Path targetPath = backupPath.resolve(backupFileName);

        // ç›´æ¥å†™å…¥JSONå­—ç¬¦ä¸²å†…å®¹
        Files.writeString(targetPath, jsonContent);

        log.debug("ğŸ“ é…ç½®å†…å®¹å·²å¤‡ä»½è‡³: {}", targetPath);
    }

}
